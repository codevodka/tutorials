<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Post Viewer (Translated)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Iconify for icons -->
    <script src="https://code.iconify.design/1/1.0.7/iconify.min.js"></script>
    <style>
        /* Custom scrollbar styling for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Style for the loading spinner */
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center py-6 mb-8 bg-white shadow-xl rounded-xl">
            <h1 class="text-3xl md:text-5xl font-extrabold text-blue-600 tracking-tight">
                WP JSON Post Viewer
            </h1>
            <p class="text-gray-500 mt-2">Displaying Posts with Lazy Loading, Search, and Translation</p>
        </header>

        <!-- Search Input -->
        <div class="mb-8 p-4 bg-white rounded-xl shadow-lg flex items-center space-x-3">
            <span class="iconify text-gray-500 text-2xl" data-icon="lucide:search"></span>
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search posts by title..."
                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                oninput="debounceSearch()"
            >
        </div>
        
        <!-- Main Content Area -->
        <div id="postsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Cards will be injected here -->
        </div>

        <!-- Notification Message Area -->
        <div id="notificationMessage" class="text-center p-4 mt-4 bg-blue-100 border border-blue-400 text-blue-700 rounded-lg hidden">
            <p id="translationNotice">Translating content from Persian to English using the LibreTranslate public API. Please allow a few seconds for data processing.</p>
        </div>
        <div id="errorBanner" class="text-center p-4 mt-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
            <p>⚠️ **Translation Failed:** Could not connect to the free translation service. Displaying content in its original language.</p>
        </div>


        <!-- Loading Indicator / End of Content -->
        <div id="statusMessage" class="text-center p-6 mt-8">
            <div id="loader" class="flex justify-center items-center h-16 hidden">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                <span class="ml-3 text-lg font-medium text-gray-600">Loading more content...</span>
            </div>
            <p id="endMessage" class="text-gray-500 font-medium hidden">All results loaded.</p>
        </div>

    </div>

    <script>
        // API Configuration
        const API_URL = 'https://downlodly.ir/wp-json/wp/v2/posts?categories=34&per_page=18&_embed=wp:featuredmedia,author,wp:term&orderby=date&order=desc';
        // LibreTranslate Public API Endpoint
        const TRANSLATE_API_URL = 'https://libretranslate.com/translate'; 

        // DOM Elements
        const postsContainer = document.getElementById('postsContainer');
        const loader = document.getElementById('loader');
        const endMessage = document.getElementById('endMessage');
        const searchInput = document.getElementById('searchInput');
        const notificationMessage = document.getElementById('notificationMessage');
        const errorBanner = document.getElementById('errorBanner');
        
        // State
        let currentPage = 1;
        let isLoading = false;
        let totalPages = 1;
        let currentSearchTerm = '';
        let debounceTimer;
        // Global switch to bypass translation if the service fails
        let translationActive = true; 

        // Utility to safely strip HTML and decode entities
        function cleanHtml(rawText) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = rawText;
            return tempDiv.textContent || tempDiv.innerText || '';
        }
        
        // Function to translate text using the LibreTranslate API
        async function translateText(text) {
            if (!translationActive || !text || text.trim() === '') return text;

            const payload = {
                q: text,
                source: 'auto',
                target: 'en',
                format: 'text'
            };

            for (let i = 0; i < 3; i++) {
                try {
                    const response = await fetch(TRANSLATE_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Rate-limiting or service error encountered
                        if (i === 2) {
                             throw new Error(`Translation failed after ${i + 1} retries.`);
                        }
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000 + Math.random() * 500));
                        continue; 
                    }

                    const result = await response.json();
                    const translatedText = result.translatedText;
                    return translatedText ? translatedText.trim() : text;
                } catch (error) {
                    console.error(`Translation attempt ${i + 1} failed:`, error);
                    if (i === 2) {
                        // All retries failed, deactivate translation globally
                        translationActive = false;
                        errorBanner.classList.remove('hidden');
                        notificationMessage.classList.add('hidden');
                        return text;
                    }
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000 + Math.random() * 500));
                }
            }
            return text; 
        }

        // Function to create a single post card element
        function createPostCard(post) {
            // Check if translation failed or was skipped, if so, use original data.
            const title = post.translatedTitle || cleanHtml(post.title.rendered);
            const excerpt = post.translatedExcerpt || cleanHtml(post.excerpt.rendered) || 'No description available.';
            
            const media = post._embedded['wp:featuredmedia'];
            const imageUrl = media && media[0]?.source_url 
                ? media[0].source_url 
                : 'https://placehold.co/600x400/3b82f6/ffffff?text=Image+Not+Available';
            
            // Format the date
            const date = new Date(post.date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden transform hover:scale-[1.02] transition duration-300 ease-in-out cursor-pointer h-full flex flex-col';
            card.onclick = () => window.open(post.link, '_blank'); 

            card.innerHTML = `
                <div class="h-48 overflow-hidden">
                    <img 
                        src="${imageUrl}" 
                        alt="${title}" 
                        class="w-full h-full object-cover transition duration-300" 
                        onerror="this.onerror=null; this.src='https://placehold.co/600x400/4a5568/ffffff?text=Failed+to+Load';"
                    >
                </div>
                <div class="p-6 flex flex-col flex-grow">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">${title}</h2>
                    <p class="text-sm text-blue-500 font-semibold mb-3 flex items-center">
                        <span class="iconify mr-1" data-icon="lucide:calendar-check"></span>
                        ${date}
                    </p>
                    <p class="text-gray-600 text-sm flex-grow mb-4 line-clamp-3">${excerpt}</p>
                    
                    <a href="${post.link}" target="_blank" class="text-blue-600 font-semibold flex items-center hover:text-blue-800 transition">
                        Read More
                        <span class="iconify ml-1 text-lg" data-icon="lucide:arrow-right-circle"></span>
                    </a>
                </div>
            `;
            return card;
        }

        // Fetch data function
        async function fetchPosts(page, searchTerm = '') {
            if (isLoading) return;

            isLoading = true;
            loader.classList.remove('hidden');
            endMessage.classList.add('hidden');
            
            if (translationActive) {
                notificationMessage.classList.remove('hidden'); 
                errorBanner.classList.add('hidden');
            } else {
                notificationMessage.classList.add('hidden'); 
            }

            // Construct the base URL with per_page=18
            let url = `${API_URL}&page=${page}`;
            
            if (searchTerm) {
                url = `https://downlodly.ir/wp-json/wp/v2/posts?categories=34&per_page=18&_embed=wp:featuredmedia,author,wp:term&orderby=date&order=desc&search=${searchTerm}&page=${page}`;
            }

            console.log('Fetching:', url);

            try {
                const response = await fetch(url);

                const totalPagesHeader = response.headers.get('X-WP-TotalPages');
                totalPages = totalPagesHeader ? parseInt(totalPagesHeader, 10) : page + 1; 

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (searchTerm) {
                    postsContainer.innerHTML = '';
                    currentPage = 1; 
                }

                if (data.length === 0 && page === 1) {
                    postsContainer.innerHTML = '<p class="text-center text-xl text-red-500 col-span-full">No results found for your search.</p>';
                    endMessage.classList.add('hidden');
                } else if (data.length === 0) {
                     endMessage.classList.remove('hidden');
                } else {
                    let processedData = data;
                    if (translationActive) {
                        // --- Translation Logic ---
                        const translationPromises = data.map(async post => {
                            const titleText = cleanHtml(post.title.rendered);
                            const excerptText = cleanHtml(post.excerpt.rendered);

                            const [translatedTitle, translatedExcerpt] = await Promise.all([
                                translateText(titleText),
                                translateText(excerptText)
                            ]);

                            return {
                                ...post,
                                // If translation failed/returned original, they will be identical, but we still assign them for consistency
                                translatedTitle: translatedTitle,
                                translatedExcerpt: translatedExcerpt
                            };
                        });
                        processedData = await Promise.all(translationPromises);
                    }
                    
                    // Render cards using the processed data
                    processedData.forEach(post => {
                        const card = createPostCard(post);
                        postsContainer.appendChild(card);
                    });
                    
                    if (page >= totalPages) {
                        endMessage.classList.remove('hidden');
                    } else if (!searchTerm) {
                        currentPage++;
                    }
                }

            } catch (error) {
                console.error('Error in fetchPosts:', error);
                if (postsContainer.children.length === 0) {
                    postsContainer.innerHTML = '<p class="text-center text-xl text-red-500 col-span-full">Failed to load main content. Please check the network connection.</p>';
                } else {
                    endMessage.innerHTML = '<p class="text-red-500">Could not load more items.</p>';
                    endMessage.classList.remove('hidden');
                }
            } finally {
                isLoading = false;
                loader.classList.add('hidden');
                // Only hide notification if translation is still active (it hides itself upon failure)
                if (translationActive) {
                    notificationMessage.classList.add('hidden'); 
                }
            }
        }

        // Debounce function for input to avoid excessive API calls while typing
        function debounceSearch() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const newSearchTerm = searchInput.value.trim();
                // Only search if the term has changed
                if (newSearchTerm !== currentSearchTerm) {
                    currentSearchTerm = newSearchTerm;
                    postsContainer.innerHTML = '';
                    currentPage = 1;
                    totalPages = 1;
                    fetchPosts(currentPage, currentSearchTerm);
                }
            }, 500); // 500ms delay
        }

        // Infinite scroll observer setup
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !isLoading && currentPage <= totalPages) {
                fetchPosts(currentPage, currentSearchTerm);
            }
        }, {
            root: null, // relative to viewport
            rootMargin: '0px 0px 200px 0px', // start loading 200px before reaching the end
            threshold: 0.1
        });

        // Create the sentinel element for observing
        const sentinel = document.createElement('div');
        sentinel.id = 'sentinel';
        sentinel.className = 'h-1 w-full mt-8';
        document.body.appendChild(sentinel);
        observer.observe(sentinel);

        // Initial load logic
        window.onload = () => {
            fetchPosts(currentPage, currentSearchTerm);

            const currentSentinel = document.getElementById('sentinel');
            if (currentSentinel) {
                observer.unobserve(currentSentinel);
                observer.observe(currentSentinel);
            }
        };

    </script>

</body>
</html>
